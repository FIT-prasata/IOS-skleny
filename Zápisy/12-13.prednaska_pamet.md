
# Správa paměti

- aby program mohl být proveden, musí nad ním být vytvořen procecs, musí mu být přidělen procesor a musí mu být přidělena paměť (a případně další zdroje)
- rozlišujeme:
    - logický adresový prostor (LAP): virtuální adresový prostor se kterým pracuje procesor při provádění kódu (každý proces i jádro má svůj)
        - má hezký spojitý adresový prostor s číslováním od 1....n
    - fyzický adresový prostor (FAP) - adresový prostor fyzických adres paměti (společný pro všechny procesy i jádro)
        - rozházeno, actual hard disk

- MMU (Memory management unit) - HW jednotka pro překlad logickýchadres na fyzické, běžně součást čipu procesoru

    <img src="Pictures/mmu.png">
    
    - proces přidělování paměti

- MMU využívá speciálních registrů a případně i hlavní paměti systému

## Přidělování paměti
- na nejnižší úrovni z hlediska blízkosti k HW se můžeme v jádře setkat s přidělování FAP pro zamapování do LAP

    - spojití bloky
    - segmenty
    - stránky (asi nejpoužívanější dnes)
    - kombinace výše uvedeného
- na vyšší úrovni se pak používá přidělování LAP pro konkrétní potřeby uživatelských procesů (malloc... - implementováno mimo režim jádra) i pro běžnou potřebu v jádře (kmalloc, vmalloc...) a to v rámci bloků LAP již zamapovaných do přidělených úseků FAP

### Spojité bloky
- procesům jsou přidělovány spojité bloky určité velikosti
- výhody: jednoduchost při režii
    - snadná implementace
    - udržujeme jen dvě informace o paměti - adresu paměti a její velikost

    <img src="Pictures/spojite_bloky.png">

- problémy:
- významně se projevuje externí fragmentace
    - přidělováním a uvolňováním paměti dochází k tvorbě nevyužitelných bloků (moc malé)
    - problém se zvětšování přiděleného prostoru
    - dynamická reorganizace paměti je nákladná
    - minimalizace pomocí různých strategií alokace paměti - mimo *first fit* můžeme používat třeba *best fit*, *worst fit*, *binary buddy (přidělují se kousky paměti o velikosti násobku dvou)...*
- při nedostatku paměti je nutné odkládat na disk veškerou paměť procesu: může být zbytečné, pomalé
- není možné jemně řídit přístupová práva, není možné sdílet části paměti
- používá se pouze ve speciálních případech

### Segmentace paměti
- něco mezi spojitými bloky a stránkováním
- LAP je rozdělen na kolekci segmentů
- různé segmenty můžou být různé velikosti
- mohou být přiděleny překladačem v době překladu (v asm ručně xd) jednotlivým částem procesu
- každy segment má číslo a velikost, logická adresa sestává z čísla segmentu a posuvu v něm

    <img src="Pictures/segmentace.png">

- segmenty se můžou používat jako jednotka ochrany, odkládání a/nebo sdílení paměti
- implementace je stále docela jednoduchá
- paměť je přidělována po segmentech - zmírnění dopadů externí fragmentace a jeměnší odkládání než u přidělování jediné oblasti - ale problém přetrváná
- jemnější řízení přístipu a sdílení
- segmentace je viditelná procesu: komplikace při překladu, možnost chyb

### Stránkování
- LAP je rozdělen na jednotky pevné velikosti: stránky (pages)
- FAP rozdělen na jednotky stejné velikosti: rámce (frames)
- vlastnosti:
    - paměť je přidělována po rámcích
    - neviditelné uživatelské proecsy
    - minimalizovány proglémy s externí fragmentací:
        - nevzniká nevyužitelný volný prostor
        - možné snížení rychlosti přístupu do paměti a alokace/dealokace
        - proto je v praxi snaha přidělovat paměť pokud možno po spojitých posloupnostech rámců, např. pomocí binary buddy
    - jemná jednotka ochrany (r/rw, user/sytem, možnost provádění - tzv. NX bit)
    - jemná kontrola odkládání po stránkách
    - složitější implementace, větší režie
    - interní fragmentace

1. verze
- v nejjednodušším případě tzv. jednoduchých (či jednoúrovňových) tabulek stránek, OS udržuje informaci o volných rámcích a pro každý proces (a jádro) tabulku stránek (page table)

    <img src="Pictures/stranky.png">

- tabulka stránek obsahuje popis mapování logických stránek do FAP a příznaky platnosti mapování, přístupu, modiikace, přístupová práva, příznak globality...
- tabulky stránek jsou udržovány v hlavní paměti
- každý odkaz na data / instrukce v paměti vyžaduje (u jednoduché tabulky stránek); dva přístupy do paměti: do tabulky stránek a na vlastní data / instrukci
- urychlení pomocí HW asociativní vyrovnávací paměti TLB (Translation Look-aside Buffer)

2. verze
- TLB obsahuje dvojice (číslo stránky, číslo rámce) + některé z příznaků spojených s daným mapováním v tabulkách stránek (přístupová oprávnění, příznak modifikace, příp. další)
- POZOR - v TLB nejsou celé stránky nebo rámce
- TLB se prohledává paralelně na základě čísla stránky a to buď plně (viz. obrázek níže), nebo částečně (dojde k indexaci skupiny buněk TLB dle části čísla stránky a pak k paralelnímu dohledání - např. by mohly být užity 2 bity z čísla stránky k rozlišení 4 množin dvojic stránek prohledávaných již tak, jak je znázorněno níže)

    <img src="Pictures/stranky2.png">

- POZOR - k TLB miss může najít vícenásobně (nezarovnaná instrukce, nezarovnaná data, data delší než jedna stránky...)
- po TLB miss:
    - u HW řízených TLB HW automaticky hledá v tabulce stránek
    - u SW řízených TLB musí v tabulce stránek hledat jádro a patřičně upravit obsah TLB
- někdy může být použito více TLB
- při přepnutí kontextu nutno obsah TLB invalidovat. Optimalizace:
    - použití globálních stránek označených zláštním příznakem v tablukce stránek
    - spojení záznamu v TLB s identifikací procesu
- invalidace TLB je nutná i po změně obsahu stránek
- některé procesory mohou dopředu nahrávat do TLB překlad pro odhadované dále prováděné instrukce
- efektivnost stránkování právě velmi silně závisí na úspěšnosti TLB

    <img src="Pictures/vypocet.png">

- Lokalita odkazů - vlastnost programu - míra toho, kolik různých shluků adres (odpovídajících typicky adresám v různých stránkách) bude proces potřebovat v krátkém časovém úseku
    - sem se kouknout na přednášku kdyžtak

    <img src="Pictures/priklad.png">

### Implementace tabulek stránek
- tabulky stránek můžou být značně rozsáhlé

    <img src="Pictures/mnoho.png">

**Hierarchické tabulky stránek**
- tabulka stránek je sama stránkována, vznikají tabulky tabulek stránek (toto ale dále zpomaluje přístup)

    <img src="Pictures/gggg.png">

- na x64 se teď používá pouze 48b, do budoucna možnost rozšíření na 52b

    <img src="Pictures/nvm.png">

    - spodních 12 bitů je offset do rámců i stránek (oboje 4kB)
    - poté 4 odkazy do tabulek 1. - 4. úrovně (každý odkaz 9b)
    - zbytek do 64b by měly být rozkopírovány znaménkové bity (prakticky buď jen 0 nebo 1)
    - na všech úrovních se provádí kontrola mapování, všechny musí být samozřejmě platné
    - zpomalení o 400%, o to větší důraz na TLB
    - někdy se používají i nižší úrovně stránkování, to se pak prakticky pracuje se stránkami o velikosti 4KiB, 2MiB nebo 1GiB

- větší velikost, složitější organizace - více úrovní, oddělení TLB pro překlad adres dat a kódu

- další optimalizace práce s TLB:
    - globální stránky
    - vstupy TLB spojené s identifikátory procesů
    - spekulativní dopředné nahrávání překladu do TLB
    - využití specializovaných cache
- zanořené hierarchické tabulky stránek

**Hashované hierarchické tabulky stránek**
- v překladových položkách ve zřetězeném seznamu může a nemusí být celé číslo stránky (nemusí tam být celé, pokud hash funkce některé bity čísla stránky spolehlivě odliší - např. pokud nikdy nebudou kolidovat čísla stránek s odlišnými n dolními bity)

    <img src="Pictures/hash.png">

- obecný zřetězený seznam překladových položek se stejnou hodnotou hash funkce může být nahrazen fixním počtem překladových položek ukládaných pro danou hodnotu hash funkce
    - v takovém případě se pak musí nějak vyhazovat jeden záznam i guess
- hashovaná tabulka může být sdílená všemi procesy (čímž se blíží invertované tabulce stránek, o které se bavíme dále; ale nemá jeden řádek pro každý rámec)
    - v takovém případě se v překladových položkách mimo čísla stránky a čísla rámce uržuje i číslo procesu (pro který proces se hledá)

**Invertovaná tabulka stránek**
- jediná tabulka udávající pro každý rámec, který proces má do něj namapovánu kterou stránku
- mapuje se přes rámce a ne přes stránky (jako jediná)

    <img src="Pictures/ffffff.png">

- výhodou je, že každý rámec mám jenom jednou a jejich počet odpovídá velikosti fyzického disku
- tabulka rámců bude vždy jen jedna
- nevýhodou je, že se dají stránky v tabulce rámců prohledávat pouze cyklem (strašlivě neefektivní)
    - takže se nejčastěji používá kombinace hashování a invertované tabulky
